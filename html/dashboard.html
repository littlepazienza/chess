
<!doctype html>

<html lang="en" class="dashboard-bg">
    <head>
        <meta charset="utf-8">

        <title>Dashboard </title>
        <meta name="description" content="The HTML5 Herald">
        <meta name="author" content="SitePoint">

        <link rel="stylesheet" href="../css/materialize.css">
        <link rel="stylesheet" href="../css/bootstrap.css">
        <link rel="stylesheet" href="../css/main.css">
        <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">

    </head>
    <body>

        <ul id="slide-out" class="sidenav">
            <li>
                <div class="user-view">
                    <a href="#"><img class="img-thumbnail" src="../img/logo.png"></a>
                    <a href="https://coldspringfederate.com"><span class="black-text name">Cold Spring Federate</span></a>
                    <a href="#"><span class="black-text email">ben.pazienza@coldspringfederate.com</span></a>
                    </div>
            </li>
            <li><a class="waves-effect" onclick="playAI()">Play our chess bot</a></li>
            <li><a class="waves-effect" data-toggle="modal" data-target="#gamesModal" onclick="getGames()">Play a friend</a></li>
        </ul>
        <a href="#" data-target="slide-out" class="sidenav-trigger nav-link h3" style="position: absolute">&#9776;</a>



        <div class="modal" tabindex="-1" role="dialog" id="gamesModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Games with friends</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="list-group" id="gamesContent">

                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="newGame(1)">New Normal Game</button>
                        <button type="button" class="btn btn-danger" onclick="newGame(0)">New Random Game</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>



<!--        <span style="font-size:30px;cursor:pointer" data-toggle="modal" data-target="sidenavmodal" onclick="openNav()">&#9776;</span>-->

        <div class="jumbotron-nobg">
            <div class="display-3">Chess</div>
            <p>Welcome <strong id="username"></strong> to Ben's Chess App. Go fuck yourself, Matt Phillips <a style="color: #FFF" href="https://twitter.com/mdot528">@mdot528</a>!</p>
        </div>


        <div class="container">
            <div class="row">

                <div class="col-md-3">
                    <h4 style="color:#fff;">Requests</h4>
                    <table class="table">

                        <tbody id="requestsTable">


                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">

                </div>
                <div class="col-md-3">
                    <h4 style="color:#fff;">Games</h4>
                    <table class="table">

                        <tbody id="gamesTable">


                        </tbody>
                    </table>
                </div>
            </div>
        </div>



        <script>
            const Store = require('electron-store');
            require('bootstrap');
            require('popper.js');
            require('materialize-css');
            const $ = require('jquery');
            const store = new Store();


            window.resizeTo(800, 600);

            let gameType = 1;

            let user = store.get('user');
            console.log(user);

            let users = [];

            $('#username').text(user.userName);


            document.addEventListener('DOMContentLoaded', function() {
                var elems = document.querySelectorAll('.sidenav');
                var instances = M.Sidenav.init(elems);
            });

            // Initialize collapsible (uncomment the lines below if you use the dropdown variation)
            // var collapsibleElem = document.querySelector('.collapsible');
            // var collapsibleInstance = M.Collapsible.init(collapsibleElem, options);

            revalidate();
            getGames();
            getRequests();

            function revalidate() {
                $.ajax({
                    method: 'POST',
                    data: JSON.stringify(user),
                    contentType: 'application/json',
                    url: `https://coldspringfederate.com/chess/validate`,
                    success: function(data) {
                        console.log(data);

                        user = data;

                    },
                    error: function (error) {
                        if(error.status == 401)
                        {
                            confirm("That was the wrong password. Do you need us to increase the font size for your illiterate octogenarian not knowing how to type loaf of bread looking ass?")
                        }
                        else if(error.status == 400)
                        {
                            alert('That username does not exist. You have 0 more attempts. If you reach 0, the FBI will be notified');
                        }else
                        {
                            console.log(error);
                        }
                    }
                });
            }

            function getGame(gameID) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${gameID}/getGame`,
                    contentType: "application/json",
                    data: JSON.stringify(user),
                    success: function (data) {
                        console.log(data);
                        let row = document.createElement("a");
                        row.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center waves-effect game";
                        row.onclick = function () {
                            if(data.accepted) {
                                window.location.href = `play.html#${data.id}`;
                            }
                        }
                        if (user.userName == data.white) {
                            row.innerText = `white vs ${data.black}`;
                        } else {
                            row.innerText = `black vs ${data.white}`;
                        }

                        let badge = document.createElement('span');
                        if(!data.accepted)
                        {
                            badge.className = 'badge badge-danger';
                            badge.innerHTML = `pending`;
                        } else if (data.isWhitesTurn && data.white == user.userName) {
                            badge.className = 'badge badge-light';
                            badge.innerText = 'Your Turn';
                        } else if (data.isWhitesTurn && data.black == user.userName) {
                            badge.className = 'badge badge-light';
                            badge.innerText = 'Their Turn'
                        } else if (!data.isWhitesTurn && data.white == user.userName) {
                            badge.className = 'badge badge-dark ';
                            badge.innerText = 'Their Turn';
                        } else if (!data.isWhitesTurn && data.black == user.userName) {
                            badge.className = 'badge badge-dark ';
                            badge.innerText = 'Your Turn';
                        }
                        row.appendChild(badge);
                        document.getElementById("gamesTable").appendChild(row);
                    },
                    error: function (error) {
                        alert('error');
                        console.log(error);
                    }
                });
            }

            function getGames() {
                $('#gamesTable').html('');
                for(let i = 0; i < user.games.length;i++) {
                    getGame(user.games[i]);
                }
            }

            function getRequests() {
                $('#requestsTable').html('');
                for(let i = 0; i < user.requested.length;i++) {
                    $.ajax({
                        method: 'POST',
                        url: `https://coldspringfederate.com/chess/${user.requested[i]}/getGame`,
                        contentType: "application/json",
                        data: JSON.stringify(user),
                        success: function (data) {
                            console.log(data);
                            if (!data.accepted) {
                                // let row = document.createElement("a");
                                // row.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center waves-effect game";
                                // row.onclick = function () {
                                //     window.location.href = `play.html#${data.id}`;
                                // }
                                // if (user.userName == data.white) {
                                //     row.innerText = `white vs ${data.black}`;
                                // } else {
                                //     row.innerText = `black vs ${data.white}`;
                                // }
                                //
                                // let badge = document.createElement('span');
                                // if (data.isWhitesTurn && data.white == user.userName) {
                                //     badge.className = 'badge badge-light';
                                //     badge.innerText = 'Your Turn';
                                // } else if (data.isWhitesTurn && data.black == user.userName) {
                                //     badge.className = 'badge badge-light';
                                //     badge.innerText = 'Their Turn'
                                // } else if (!data.isWhitesTurn && data.white == user.userName) {
                                //     badge.className = 'badge badge-dark ';
                                //     badge.innerText = 'Their Turn';
                                // } else if (!data.isWhitesTurn && data.black == user.userName) {
                                //     badge.className = 'badge badge-dark ';
                                //     badge.innerText = 'Your Turn';
                                // }
                                // row.appendChild(badge);
                                // document.getElementById("gamesTable").appendChild(row);
                                let row = document.createElement("div");
                                row.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center request";
                                if (user.userName == data.white) {
                                    row.innerText = `vs ${data.black}`;
                                } else {
                                    row.innerText = `vs ${data.white}`;
                                }
                                let accept = document.createElement('button');
                                accept.className = 'btn accept';
                                accept.onclick = function () {
                                    acceptGame(data.id);
                                }
                                let cancel = document.createElement('button');
                                cancel.className = 'btn cancel';
                                cancel.onclick = function () {
                                    rejectGame(data.id);
                                }

                                row.onmouseenter = function () {
                                    row.appendChild(accept);
                                    row.appendChild(cancel);
                                }
                                row.onmouseleave = function() {
                                    row.removeChild(accept);
                                    row.removeChild(cancel);
                                }
                                document.getElementById("requestsTable").appendChild(row);

                            } else {
                                console.log(`Error this game shouldn't be accepted`);
                            }
                        },
                        error: function (error) {
                            alert('error');
                            console.log(error);
                        }
                    });
                }
            }


            function newGame(x) {
                gameType = x;
                $.ajax({
                    method: 'GET',
                    url: "https://coldspringfederate.com/chess/getUsers",
                    success: function (data) {
                        users = data;
                    },
                    error: function (error) {
                        console.log(error);
                    }
                })

                document.getElementById("gamesContent").innerHTML = '\t<div class="dropdown"><input id="searchInput" type="text" placeholder="Search..." onkeyup="updateAutocomplete()"><br><div aria-labelledby="dropdownMenuButton" id="dropdownMenuBody"></div></div>'
                updateAutocomplete();
            }

            function acceptGame(x) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${x}/acceptGame`,
                    data: JSON.stringify(user),
                    contentType: "application/json",
                    success: function (data) {
                        console.log(data);
                        getRequests();
                        getGame(data.id);
                    },
                    error: function(error) {
                        console.log(error);
                    }
                })
            }

            function rejectGame(x) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${x}/rejectGame`,
                    data: JSON.stringify(user),
                    contentType: "application/json",
                    success: function (data) {
                        console.log(data);
                        window.location.reload();
                    },
                    error: function(error) {
                        console.log(error);
                    }
                })
            }

            function updateAutocomplete()
            {
                let val = document.getElementById("searchInput").value;

                let htmlStr = ""

                if(val.length > 1)
                {
                    for(let i = 0; i < users.length; i++)
                    {
                        let str = users[i];

                        if(str.toLowerCase().includes(val.toLowerCase()))
                        {
                            let index = str.toLowerCase().indexOf(val.toLowerCase());
                            let boldStr = `${str.substring(0, index)}<strong>${str.substring(index, index+val.length)}</strong>${str.substring(index+val.length, str.length)}`;
                            htmlStr += `<button class="btn dropdown-item btn-primary" data-dismiss="modal" style="padding-left: 2px" onclick="requestGame('${users[i]}')">${boldStr}</button>`;
                        }
                    }
                }

                document.getElementById("dropdownMenuBody").innerHTML = htmlStr;
            }

            function requestGame(x) {
                $.ajax({
                    method: 'POST',
                    contentType: "application/json",
                    data: `${gameType}`,
                    url: `https://coldspringfederate.com/chess/${user.userName}/${x}/newGame`,
                    success: function(data) {

                    },
                    error: function(error) {

                    }
                })
            }

        </script>

    </body>
</html>

