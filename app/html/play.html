<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>Ben's Frat Star Exclusive Chess App </title>
        <meta name="description" content="The HTML5 Herald">
        <meta name="author" content="SitePoint">

        <link rel="stylesheet" href="../css/materialize.css">

        <link rel="stylesheet" href="../css/bootstrap.css">
        <link rel="stylesheet" href="../css/main.css">

    </head>


    <body>



        <div class="modal" tabindex="-1" role="dialog" id="gameOverModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Game Over</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="gameOverContent">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="rematch()">Rematch</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal" tabindex="-1" role="dialog" id="queeningModal">
            <div class="modal-dialog" role="document">
                <div class="promotion-content">
                    <div class="modal-header">
                        Pawn Promotion
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="queenChoice">

                        <table>
                            <tbody>
                                <tr>
                                   <td class="tile white-tile" id="queen">

                                   </td>
                                    <td class="tile white-tile" id="bishop">

                                    </td>
                                </tr>

                                <tr>
                                    <td class="tile white-tile" id="knight">

                                    </td>
                                    <td class="tile white-tile" id="rook">

                                    </td>
                                </tr>
                            </tbody>

                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>



        <div class="player-info-container">
            <div class="player-info" id="otherContainer">
                <div class="profile-image" id="otherProfile"></div>
                <div class="username" id="otherUserName"></div>
                <div class="advantage" id="otherAdvantage"></div>
                <div class="taken-pieces-container" id="otherTakenPieces"></div>
                <div class="turn float-right" id="isOthersTurn"></div>
            </div>
        </div>

            <div class="chessboard-container">



                    <table class="chessboard">
                        <tbody>
                            <tr>
                                <!--                                    <td id="rank0">8</td>-->
                                <td id="7,0" class="tile white-tile"></td>
                                <td id="7,1" class="tile black-tile"></td>
                                <td id="7,2" class="tile white-tile"></td>
                                <td id="7,3" class="tile black-tile"></td>
                                <td id="7,4" class="tile white-tile"></td>
                                <td id="7,5" class="tile black-tile"></td>
                                <td id="7,6" class="tile white-tile"></td>
                                <td id="7,7" class="tile black-tile"><p id="rank0" class="file-subscript">8</p></td>
                            </tr>
                            <tr>
                                <!--                                    <td id="rank1">7</td>-->
                                <td id="6,0" class="tile black-tile"></td>
                                <td id="6,1" class="tile white-tile"></td>
                                <td id="6,2" class="tile black-tile"></td>
                                <td id="6,3" class="tile white-tile"></td>
                                <td id="6,4" class="tile black-tile"></td>
                                <td id="6,5" class="tile white-tile"></td>
                                <td id="6,6" class="tile black-tile"></td>
                                <td id="6,7" class="tile white-tile"><p id="rank1" class="file-subscript">7</p></td>
                            </tr>
                            <tr>
                                <!--                                    <td id="rank2">6</td>-->
                                <td id="5,0" class="tile white-tile"></td>
                                <td id="5,1" class="tile black-tile"></td>
                                <td id="5,2" class="tile white-tile"></td>
                                <td id="5,3" class="tile black-tile"></td>
                                <td id="5,4" class="tile white-tile"></td>
                                <td id="5,5" class="tile black-tile"></td>
                                <td id="5,6" class="tile white-tile"></td>
                                <td id="5,7" class="tile black-tile"><p id="rank2" class="file-subscript">6</p></td>
                            </tr>
                            <tr>
                                <!--                                    <td id="rank3">5</td>-->
                                <td id="4,0" class="tile black-tile"></td>
                                <td id="4,1" class="tile white-tile"></td>
                                <td id="4,2" class="tile black-tile"></td>
                                <td id="4,3" class="tile white-tile"></td>
                                <td id="4,4" class="tile black-tile"></td>
                                <td id="4,5" class="tile white-tile"></td>
                                <td id="4,6" class="tile black-tile"></td>
                                <td id="4,7" class="tile white-tile"><p id="rank3" class="file-subscript">5</p></td>
                            </tr>
                            <tr>
                                <!--                                    <td id="rank4">4</td>-->
                                <td id="3,0" class="tile white-tile"></td>
                                <td id="3,1" class="tile black-tile"></td>
                                <td id="3,2" class="tile white-tile"></td>
                                <td id="3,3" class="tile black-tile"></td>
                                <td id="3,4" class="tile white-tile"></td>
                                <td id="3,5" class="tile black-tile"></td>
                                <td id="3,6" class="tile white-tile"></td>
                                <td id="3,7" class="tile black-tile"><p id="rank4" class="file-subscript">4</p></td>
                            </tr>
                            <tr>
                                <!--                                    <td id="rank5">3</td>-->
                                <td id="2,0" class="tile black-tile"></td>
                                <td id="2,1" class="tile white-tile"></td>
                                <td id="2,2" class="tile black-tile"></td>
                                <td id="2,3" class="tile white-tile"></td>
                                <td id="2,4" class="tile black-tile"></td>
                                <td id="2,5" class="tile white-tile"></td>
                                <td id="2,6" class="tile black-tile"></td>
                                <td id="2,7" class="tile white-tile"><p id="rank5" class="file-subscript">3</p></td>
                            </tr>

                            <tr>
                                <!--                                    <td id="rank6">2</td>-->
                                <td id="1,0" class="tile white-tile"></td>
                                <td id="1,1" class="tile black-tile"></td>
                                <td id="1,2" class="tile white-tile"></td>
                                <td id="1,3" class="tile black-tile"></td>
                                <td id="1,4" class="tile white-tile"></td>
                                <td id="1,5" class="tile black-tile"></td>
                                <td id="1,6" class="tile white-tile"></td>
                                <td id="1,7" class="tile black-tile"><p id="rank6" class="file-subscript">2</p></td>
                            </tr>
                            <tr>
                                <p hidden id="rank7">1</p>
                                <td id="0,0" class="tile black-tile"><p id="file0" class="file-subscript">a</p></td>
                                <td id="0,1" class="tile white-tile"><p id="file1" class="file-subscript">b</p></td>
                                <td id="0,2" class="tile black-tile"><p id="file2" class="file-subscript">c</p></td>
                                <td id="0,3" class="tile white-tile"><p id="file3" class="file-subscript">d</p></td>
                                <td id="0,4" class="tile black-tile"><p id="file4" class="file-subscript">e</p></td>
                                <td id="0,5" class="tile white-tile"><p id="file5" class="file-subscript">f</p></td>
                                <td id="0,6" class="tile black-tile"><p id="file6" class="file-subscript">g</p></td>
                                <td id="0,7" class="tile white-tile"><p id="file7" class="file-subscript">h</p></td>
                            </tr>
                        </tbody>
                    </table>

            </div>

        <div class="player-info-container">
            <div class="player-info" id="currentContainer">

                <div class="profile-image" id="currentProfile"></div>
                <div class="username" id="currentUserName"></div>
                <div class="advantage" id="currentAdvantage"></div>
                <div class="taken-pieces-container" id="currentTakenPieces"></div>
                <div class="turn float-right" id="isCurrentsTurn"></div>
            </div>
        </div>



        <script>window.$ = window.jQuery = require('jquery');</script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>

        <script>
            const Store = require('electron-store');
            require('electron');
            require('popper.js');
            require('materialize-css');
            const $ = require('jquery');
            require('bootstrap');
            const Chess = require('../js/chess');
            const store = new Store();

            const devMode = true;

            const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];


            document.addEventListener('DOMContentLoaded', function() {
                var elems = document.querySelectorAll('.sidenav');
                var instances = M.Sidenav.init(elems);
            });

            window.resizeTo(800, 620);

            let user = store.get('user');

            let gid = window.location.hash.substring(1);
            console.log(gid)

            let game = undefined;

            getGame();

            function updateBoard() {

                document.getElementById('otherTakenPieces').innerHTML = '';
                document.getElementById('currentTakenPieces').innerHTML = '';
                document.getElementById('isCurrentsTurn').innerHTML = '';
                document.getElementById('isOthersTurn').innerHTML = '';

                if(game.isWhitesTurn && game.white == user.userName)
                {
                    let badge = document.createElement('span');
                    badge.className = 'badge badge-light';
                    badge.innerText = 'Your Turn';
                    document.getElementById('isCurrentsTurn').appendChild(badge);
                }
                else if (game.isWhitesTurn && game.black == user.userName)
                {
                    let badge = document.createElement('span');
                    badge.className = 'badge badge-light';
                    badge.innerText = 'Their Turn'
                    document.getElementById('isOthersTurn').appendChild(badge);
                }
                else if (!game.isWhitesTurn && game.white == user.userName)
                {
                    let badge = document.createElement('span');
                    badge.className = 'badge badge-dark ';
                    badge.innerText = 'Their Turn';
                    document.getElementById('isOthersTurn').appendChild(badge);
                }
                else if (!game.isWhitesTurn && game.black == user.userName)
                {
                    let badge = document.createElement('span');
                    badge.className = 'badge badge-dark ';
                    badge.innerText = 'Your Turn';
                    document.getElementById('isCurrentsTurn').appendChild(badge);
                }

                if(game.white == user.userName)
                {
                    document.getElementById("otherContainer").className = "player-info bg-dark text-light";
                    document.getElementById("currentContainer").className = "player-info bg-light text-dark";
                    let adv = game.getAdvantage();
                    if(adv > 0)
                    {
                        document.getElementById('otherAdvantage').innerText = `+${adv}`
                    }
                    else if(adv < 0)
                    {
                        document.getElementById('currentAdvantage').innerText = `+${Math.abs(adv)}`;
                    }
                    else
                    {
                        document.getElementById('otherAdvantage').innerText = ``;
                    }

                    for(let i = 0; i < game.takenPieces.length;i++)
                    {
                        if(!game.takenPieces[i].isWhite)
                        {
                            let img = document.createElement('img');
                            img.src = game.takenPieces[i].getImg();
                            img.className = 'piece-icon';
                            document.getElementById('currentTakenPieces').appendChild(img);
                        }
                        else
                        {
                            let img = document.createElement('img');
                            img.src = game.takenPieces[i].getImg();
                            img.className = 'piece-icon';
                            document.getElementById('otherTakenPieces').appendChild(img);
                        }
                    }
                }
                else
                {
                    document.getElementById("currentContainer").className = "player-info bg-dark text-light";
                    document.getElementById("otherContainer").className = "player-info bg-light text-dark";

                    let adv = game.getAdvantage();
                    if(adv > 0)
                    {
                        document.getElementById('currentAdvantage').innerText = `+${adv}`
                    }
                    else if (adv < 0)
                    {
                        document.getElementById('otherAdvantage').innerText = `+${Math.abs(adv)}`;
                    }
                    else
                    {
                        document.getElementById('otherAdvantage').innerText = ``;
                    }

                    for(let i = 0; i < game.takenPieces.length;i++)
                    {
                        if(game.takenPieces[i].isWhite)
                        {
                            let img = document.createElement('img');
                            img.src = game.takenPieces[i].getImg();
                            img.className = 'piece-icon';
                            document.getElementById('otherTakenPieces').appendChild(img);
                        }
                        else
                        {
                            let img = document.createElement('img');
                            img.src = game.takenPieces[i].getImg();
                            img.className = 'piece-icon';
                            document.getElementById('currentTakenPieces').appendChild(img);
                        }
                    }
                }

                for(let i = 0; i < game.board.length;i++)
                {
                    for(let j = 0; j < game.board[i].length;j++) {
                        let cell = null;
                        if(game.white == user.userName)
                        {
                            cell = document.getElementById(`${BOARD_SIZE - i},${j}`);
                        }
                        else
                        {
                            cell = document.getElementById(`${i},${BOARD_SIZE-j}`);
                        }
                        removePieces(cell);
                        // cell.innerHTML = "";
                        if (game.board[i][j] != null) {
                            let img = document.createElement('img');
                            img.src = game.board[i][j].getImg();
                            img.className = "piece";

                            $(img).draggable({
                                snap: '.tile',
                                snapMode: 'both',
                            });

                            cell.appendChild(img);
                        }

                        $(cell).droppable();

                        cell.ondrop = async function (ev, ui) {

                            let from = ui.draggable[0].parentNode.id.split(',');
                            let to = cell.id.split(',');
                            let move = null;


                            if (game.white == user.userName) {
                                move = newMove(BOARD_SIZE - parseInt(from[0]), parseInt(from[1]), BOARD_SIZE - parseInt(to[0]), parseInt(to[1]));
                            } else {
                                move = newMove(parseInt(from[0]), BOARD_SIZE - parseInt(from[1]), parseInt(to[0]), BOARD_SIZE - parseInt(to[1]));
                            }
                            if (!devMode && ((game.board[move.fromR][move.fromF].isWhite && game.white != user.userName) || (!game.board[move.fromR][move.fromF].isWhite && game.black != user.userName))) {
                                update();
                                console.log('here')
                                $('#isOthersTurn').addClass('glow');
                                await sleep(2000);
                                $('#isOthersTurn').removeClass('glow');
                            }
                            else if (game.validMove(move))
                            {
                                if (game.isQueening(move)) {
                                    $('#queen').html(`<img class="piece" src="${newQueen(true).getImg()}" data-dismiss="modal" onclick="submitQueeningChoice('${move}', ${TO_QUEEN})">`);
                                    $('#bishop').html(`<img class="piece" src="${newBishop(true).getImg()}" data-dismiss="modal" onclick="submitQueeningChoice('${move}', ${TO_BISHOP})">`);
                                    $('#rook').html(`<img class="piece" src="${newRook(true).getImg()}" data-dismiss="modal" onclick="submitQueeningChoice('${move}', ${TO_ROOK})">`);
                                    $('#knight').html(`<img class="piece" src="${newKnight(true).getImg()}" data-dismiss="modal" onclick="submitQueeningChoice('${move}', ${TO_KNIGHT})">`);
                                    $('#queeningModal').modal('show');
                                } else if (game.isCastling(move)) {
                                    // this.board[move.fromR][(move.toF==2?3:5)] = this.board[move.fromR][(move.toF==2?0:7)];
                                    // this.board[move.fromR][(move.toF==2?0:7)].notMoved = false;
                                    // this.board[move.fromR][(move.toF==2?0:7)] = null;
                                    makeCastlingMove(newMove(move.fromR, move.toF == 2 ? 0 : 7, move.fromR, move.toF == 2 ? 3 : 5));
                                    makeMove(move);
                                } else {
                                    makeMove(move);
                                }
                            }
                            else
                            {
                                update();
                            }
                        }
                    }
                }
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            function removePieces(cell)
            {
                let toRem = [];
                for(let i = 0; i < cell.childElementCount; i++)
                {
                    let child = cell.childNodes[i];
                    console.log(child);
                    if(child.tagName == "IMG") {
                        toRem.push(child);
                    }
                }

                for(let i = 0; i < toRem.length;i++)
                {
                    cell.removeChild(toRem[i]);
                }
            }

            function submitQueeningChoice(move, queeningChoice) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${game.id}/${queeningChoice}/makePromotionMove`,
                    data: JSON.stringify(newMoveStr(move)),
                    contentType: 'application/json',
                    success: function(data) {
                        game = newGame(data.board, data.type, data.white, data.black, data.accepted, data.whitesTurn, data.id, data.takenPieces);
                        update();
                    },
                    error: function (error) {

                    }
                })
            }

            function makeCastlingMove(move) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${game.id}/makeCastlingMove`,
                    data: JSON.stringify(move),
                    contentType: 'application/json',
                    success: function(data) {
                        game = newGame(data.board, data.type, data.white, data.black, data.accepted, data.whitesTurn, data.id, data.takenPieces);
                        update();
                    },
                    error: function (error) {

                    }
                })
            }

            function makeMove(move) {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${game.id}/makeMove`,
                    data: JSON.stringify(move),
                    contentType: 'application/json',
                    success: function(data) {
                        game = newGame(data.board, data.type, data.white, data.black, data.accepted, data.whitesTurn, data.id, data.takenPieces);
                        update();
                    },
                    error: function (error) {

                    }
                })
            }

            function getGame() {
                $.ajax({
                    method: 'POST',
                    url: `https://coldspringfederate.com/chess/${gid}/getGame`,
                    contentType: "application/json",
                    data: JSON.stringify(user),
                    success: function(data) {
                        console.log(data);

                        //global.newGame = function(board, type, white, black, accepted, isWhitesTurn, id) {
                        game = newGame(data.board, data.type, data.white, data.black, data.accepted, data.whitesTurn, data.id, data.takenPieces);
                        if(game.white == user.userName)
                        {
                            document.getElementById('currentProfile').innerText = `${game.white.charAt(0).toUpperCase()}`;
                            document.getElementById('currentUserName').innerText = `${game.white}`;
                            document.getElementById('otherProfile').innerText = `${game.black.charAt(0).toUpperCase()}`;
                            document.getElementById('otherUserName').innerText = `${game.black}`;

                            for(let i = 0; i <= BOARD_SIZE;i++)
                            {
                                document.getElementById(`file${BOARD_SIZE-i}`).innerText = files[BOARD_SIZE-i];
                                document.getElementById(`rank${BOARD_SIZE-i}`).innerText = (i+1);
                            }
                        }
                        else
                        {
                            document.getElementById('currentProfile').innerText = `${game.black.charAt(0).toUpperCase()}`;
                            document.getElementById('currentUserName').innerText = `${game.black}`;
                            document.getElementById('otherProfile').innerText = `${game.white.charAt(0).toUpperCase()}`;
                            document.getElementById('otherUserName').innerText = `${game.white}`;

                            for(let i = 0; i <= BOARD_SIZE;i++)
                            {
                                document.getElementById(`file${i}`).innerText = files[BOARD_SIZE-i];
                                document.getElementById(`rank${i}`).innerText = (i+1);
                            }
                        }
                        update();
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });

            }

            function update()
            {
                updateBoard();
                if(game.isCheckMate(true)) {
                    $('#gameOverModal').modal('show');
                }
                if(game.isCheckMate(false)) {
                    $('#gameOverModal').modal('show');
                }

            }

            // function newGame(x) {
            //     gameType = x;
            //     $.ajax({
            //         method: 'GET',
            //         url: "https://coldspringfederate.com/chess/getUsers",
            //         success: function (data) {
            //             users = data;
            //         },
            //         error: function (error) {
            //             console.log(error);
            //         }
            //     })
            //
            //     document.getElementById("gamesContent").innerHTML = '\t<div class="dropdown"><input id="searchInput" type="text" placeholder="Search..." onkeyup="updateAutocomplete()"><br><div aria-labelledby="dropdownMenuButton" id="dropdownMenuBody"></div></div>'
            //     updateAutocomplete();
            // }


        </script>

    </body>
</html>
